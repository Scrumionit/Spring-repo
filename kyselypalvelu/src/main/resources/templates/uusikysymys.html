<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <title>Uusi kysymys</title>
  <meta charset="UTF-8" />
  <!-- added stylesheet -->
  <link rel="stylesheet" href="/index.css" />
</head>

<body class="app">
  <div class="card-wrapper">
    <div class="card">
      <!-- removed top-level back button; it will be next to submit below -->
      <h1>Uusi kysymys</h1>

      <form th:object="${kysymys}" th:action="@{/kysely/{kyselyId}/tallennakysymys(kyselyId=${kysely.kysely_id})}" method="post" onsubmit="return validateKysymys(this);">
        <input type="hidden" name="kyselyId" th:value="${kysely.kysely_id}" readonly="readonly" />

        <label for="kysymystyyppi">Kysymystyyppi:</label>
        <select id="kysymystyyppi" th:field="*{kysymystyyppi.kysymystyyppi_id}" class="form-control" required>
            <option th:each="k: ${kysymystyypit}"
              th:value="${k.kysymystyyppi_id}"
              th:text="${k.nimi}">
            </option>
        </select>

        <label for="kysymysteksti">Kysymys:</label>
        <textarea id="kysymysteksti" th:field="*{kysymysteksti}" required></textarea>

        <div id="vaihtoehdotBlock" th:attr="style=${kysymys.kysymystyyppi == null or kysymys.kysymystyyppi.nimi != 'Avoin'} ? '' : 'display:none;'">
          <label>Vastausvaihtoehdot:</label>
          <div id="options">
            <!-- render existing vaihtoehdot if any -->
            <div th:each="v,iterStat : ${kysymys.vaihtoehdot}" class="option-row">
              <input type="text" th:field="*{vaihtoehdot[__${iterStat.index}__].teksti}" />
              <button type="button" class="remove-option">Poista</button>
            </div>
            <!-- if none, render one empty input so user can start -->
            <div th:if="${kysymys.vaihtoehdot == null or #lists.isEmpty(kysymys.vaihtoehdot)}" class="option-row">
              <input type="text" th:field="*{vaihtoehdot[0].teksti}" />
              <button type="button" class="remove-option">Poista</button>
            </div>
          </div>
          <button type="button" id="addOption">Lisää vaihtoehto</button>
        </div>

        <script>
          (function () {
            const select = document.getElementById('kysymystyyppi');
            const block = document.getElementById('vaihtoehdotBlock');
            const optionsContainer = document.getElementById('options');
            const addBtn = document.getElementById('addOption');

            if (!select || !block || !optionsContainer || !addBtn) return;

            function toggleBlock() {
              const text = select.options[select.selectedIndex].text.trim().toLowerCase();
              block.style.display = (text === 'avoin') ? 'none' : '';
            }

            function updateIndices() {
              const rows = optionsContainer.querySelectorAll('.option-row');
              rows.forEach((row, idx) => {
                const input = row.querySelector('input');
                input.name = 'vaihtoehdot[' + idx + '].teksti';
                input.id = 'vaihtoehdot_' + idx + '_teksti';
              });
            }

            function addOption(value) {
              const idx = optionsContainer.querySelectorAll('.option-row').length;
              const row = document.createElement('div');
              row.className = 'option-row';
              const input = document.createElement('input');
              input.type = 'text';
              input.name = 'vaihtoehdot[' + idx + '].teksti';
              input.id = 'vaihtoehdot_' + idx + '_teksti';
              if (value) input.value = value;
              const removeBtn = document.createElement('button');
              removeBtn.type = 'button';
              removeBtn.className = 'remove-option';
              removeBtn.textContent = 'Poista';
              removeBtn.addEventListener('click', function () {
                row.remove();
                updateIndices();
              });
              row.appendChild(input);
              row.appendChild(removeBtn);
              optionsContainer.appendChild(row);
            }

            // wire up existing remove buttons (rendered by Thymeleaf)
            optionsContainer.querySelectorAll('.remove-option').forEach(btn => {
              btn.addEventListener('click', function (e) {
                const row = e.target.closest('.option-row');
                if (row) {
                  row.remove();
                  updateIndices();
                }
              });
            });

            addBtn.addEventListener('click', function () {
              addOption('');
            });

            // initialize block visibility and indices after DOM ready
            document.addEventListener('DOMContentLoaded', function () {
              toggleBlock();
              updateIndices();
            });

            // also watch for change on select
            select.addEventListener('change', toggleBlock);

            // expose validation for the form
            window.validateKysymys = function (form) {
              // basic required checks
              const selectEl = form.querySelector('#kysymystyyppi');
              const textEl = form.querySelector('#kysymysteksti');
              if (!selectEl || !selectEl.value) {
                alert('Valitse kysymystyyppi.');
                if (selectEl) selectEl.focus();
                return false;
              }
              if (!textEl || !textEl.value.trim()) {
                alert('Kirjoita kysymysteksti.');
                if (textEl) textEl.focus();
                return false;
              }
              // if options block is visible, ensure at least one non-empty option
              if (block && block.style.display !== 'none') {
                const optionInputs = optionsContainer.querySelectorAll('input[type="text"]');
                let hasValid = false;
                optionInputs.forEach(i => { if (i.value && i.value.trim()) hasValid = true; });
                if (!hasValid) {
                  alert('Lisää vähintään yksi vastausvaihtoehto.');
                  return false;
                }
              }
              return true;
            };

          })();
        </script>
        <br />
        <!-- actions: save + back next to each other -->
        <div class="actions">
          <input type="submit" value="Tallenna kysymys" class="btn btn-primary" />
          <a th:href="@{/kysely/{id}(id=${kysely.kysely_id})}" class="btn btn-secondary">Takaisin kyselyyn</a>
        </div>
      </form>
    </div>
  </div>
</body>

</html>